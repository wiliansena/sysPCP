{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm mt-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-edit me-2"></i> Editar Quebra — Alça</h5>
    <div class="d-flex gap-2">
      <a href="{{ url_for('routes.ver_quebra_alca', id=it.id) }}" class="btn btn-info">
        <i class="fas fa-eye"></i> Ver
      </a>
      <a href="{{ url_for('routes.listar_quebras_alca') }}" class="btn btn-secondary">
        Voltar
      </a>
    </div>
  </div>

  <div class="card-body">
    <form method="POST">
      {{ form.csrf_token }}

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label mb-1">{{ form.data_quebra.label }}</label>
          {{ form.data_quebra(class="form-control") }}
          {% for e in form.data_quebra.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-9">
          <label class="form-label mb-1">{{ form.alca_id.label }}</label>
          {{ form.alca_id(class="form-select select2", id="alca_id") }}
          {% for e in form.alca_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-12">
          <label class="form-label mb-1">{{ form.observacao.label }}</label>
          {{ form.observacao(class="form-control", rows="2") }}
        </div>
      </div>

      <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0"><i class="fas fa-ruler-combined me-2"></i> Tamanhos</h6>
          <span class="text-muted small">Atualize as quantidades de quebra</span>
        </div>

        <div id="box-tamanhos" class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Tamanho</th>
                <th class="text-end" style="width:180px;">Quantidade quebrada</th>
              </tr>
            </thead>
            <tbody id="tamanhos-body">
              {% for tid, tnome in tamanhos %}
              <tr>
                <td>{{ tnome }}</td>
                <td class="text-end">
                  <input type="number" min="0" step="1"
                         class="form-control text-end qtd-input"
                         name="qtd_{{ tid }}"
                         value="{{ qtd_por_tam.get(tid, 0) }}">
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-muted text-center">Esta alça não possui tamanhos cadastrados.</td></tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th class="text-end">Total</th>
                <th class="text-end"><span id="total-qtd">0</span></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> Salvar
        </button>
        <a href="{{ url_for('routes.listar_quebras_alca') }}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<script>
  function recalc() {
    let s = 0;
    $('.qtd-input').each(function(){
      const v = parseInt($(this).val() || '0', 10);
      if (!isNaN(v)) s += v;
    });
    $('#total-qtd').text(s);
  }

  async function recarregarTamanhos() {
    const aid = parseInt($('#alca_id').val() || '0', 10);
    if (!aid) return;

    const url = `{{ url_for('routes.api_quebra_alca_tamanhos') }}?alca_id=${aid}`;
    try {
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
      const data = await resp.json();
      if (!data.ok) return;

      const body = $('#tamanhos-body');
      body.empty();
      (data.tamanhos || []).forEach(t => {
        body.append(`
          <tr>
            <td>${t.nome}</td>
            <td class="text-end">
              <input type="number" min="0" step="1" class="form-control text-end qtd-input" name="qtd_${t.id}" value="0">
            </td>
          </tr>
        `);
      });
      $('.qtd-input').on('input', recalc);
      recalc();
    } catch(e) {}
  }

  $(function(){
    $('.select2').select2({ width:'100%', placeholder:'Selecione...', allowClear:true });
    $('.qtd-input').on('input', recalc);
    recalc();

    // Se trocar a alça na edição, recarrega a grade (zera quantidades)
    $('#alca_id').on('change', recarregarTamanhos);
  });
</script>
{% endblock %}
