{% extends "base.html" %}
{% block content %}
<style>
  .sheet {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 5px 18px rgba(0, 0, 0, .08)
  }

  .tbl-sheet {
    width: 100%;
    border-collapse: collapse;
    font-size: .95rem
  }

  .tbl-sheet th,
  .tbl-sheet td {
    border: 1px solid #bbb;
    padding: 6px 8px;
    text-align: center;
    vertical-align: middle
  }

  .tbl-sheet thead th {
    background: #f3f3f3;
    font-weight: 700
  }

  .celula-amarela {
    background: #ffe799
  }

  .col-hora {
    width: 110px;
    font-weight: 700;
    position: sticky;
    left: 0;
    background: #fff;
    z-index: 1
  }

  .subhead {
    font-size: .8rem;
    color: #666;
    display: block
  }

  .titulo {
    font-weight: 800;
    letter-spacing: .2px
  }

  .tot-col {
    background: #eaf3ff;
    text-align: left
  }

  .badge-soft {
    display: block;
    width: 100%;
    text-align: left;
    background: #e7f1ff;
    color: #0d47a1;
    padding: 2px 6px;
    border-radius: 4px;
    margin-bottom: 4px
  }

  .scroll-x {
    overflow-x: auto
  }
</style>

<div class="container mt-4">
  <!-- Cabeçalho + filtros -->
  <div class="mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-lg">
        <h5 class="titulo mb-0">
          PRODUÇÃO CONVENCIONAL — {{ data_ini.strftime('%d/%m/%Y') }}{% if data_fim != data_ini %} a {{
          data_fim.strftime('%d/%m/%Y') }}{% endif %}
        </h5>
      </div>
      <div class="col-12 col-lg-auto">
        <form method="get" class="row row-cols-auto g-2 justify-content-lg-end align-items-center">
          <div class="col"><input type="date" name="data_ini" class="form-control form-control-sm"
              value="{{ data_ini.strftime('%Y-%m-%d') }}"></div>
          <div class="col"><input type="date" name="data_fim" class="form-control form-control-sm"
              value="{{ data_fim.strftime('%Y-%m-%d') }}"></div>
          <div class="col"><button class="btn btn-sm btn-primary"><i class="fas fa-rotate me-1"></i><span
                class="d-none d-sm-inline">Filtrar</span></button></div>
          <div class="col">
            <a href="{{ url_for('routes.nova_folha_producao_convencional', data=(data_ini.strftime('%Y-%m-%d'))) }}"
              class="btn btn-success">
              <i class="fas fa-plus"></i> Nova Produção
            </a>
          </div>
          <div class="col">
            <a class="btn btn-sm btn-secondary"
              href="{{ url_for('routes.listar_producoes_convencionais', data=data_fim) }}">
              <i class="fa fa-undo me-1"></i><span class="d-none d-sm-inline">Voltar</span>
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  <hr>
  {% for bloco in maquinas_blocos %}
  <div class="sheet mb-4 scroll-x">
    <table class="tbl-sheet">
      <thead>
        <tr>
          <th class="col-hora">HORA</th>
          {% for m in bloco %}
          <th>{{ m.codigo if m.codigo is not none else m.id }}<br><span class="subhead">INJ</span></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for h in horarios %}
        <tr>
          <td class="col-hora">{{ h.replace('h',':') }}</td>

          {% for m in bloco %}
          {% set regs = mapa_multi.get((h, m.id), []) %}
          <td class="celula-amarela">
            {% if regs %}
            {% for r in regs %}
            <span class="d-block fw-semibold">{{ r.quantidade }}</span>
            <small class="d-block text-muted" style="line-height:1;">{{ r.tipo_material }}</small>
            {% if not loop.last %}<span class="d-block" style="height:4px;"></span>{% endif %}
            {% endfor %}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</div>

<hr>

{# === RESUMO POR INTERVALO (totais por tipo em cada horário) === #}
<div class="sheet mb-4">
  <table class="tbl-sheet">
    <thead>
      <tr>
        <th style="width:120px">INTERVALO</th>
        <th>ALCA</th>
        <th>SOLADO</th>
        <th>MICRO</th>
        <th>AMOSTRA</th>
        <th style="width:120px">TOTAL GERAL<BR>INTERVALO</th>
      </tr>
    </thead>
    <tbody>
      {% for h in horarios %}
      {% set ti = totais_por_intervalo.get(h, {}) %}
      {% set a = ti.get('ALCA', 0) %}
      {% set s = ti.get('SOLADO', 0) %}
      {% set m = ti.get('MICRO', 0) %}
      {% set am = ti.get('AMOSTRA', 0) %}
      {% set linha_total = a + s + m + am %}
      <tr>
        <td class="text-start fw-semibold">{{ h.replace('h',':') }}</td>
        <td>{{ a }}</td>
        <td>{{ s }}</td>
        <td>{{ m }}</td>
        <td>{{ am }}</td>
        <td class="fw-bold">{{ linha_total }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Resumo do PERÍODO -->
<div class="sheet mb-4" style="max-width:560px; margin-left:auto; margin-right:auto;">
  <table class="tbl-sheet">
    <thead>
      <tr>
        <th colspan="2" style="background:#004085; color:#fff">
          TOTAL DO PERÍODO ({{ data_ini.strftime('%d/%m/%Y') }}{% if data_fim != data_ini %} a {{ data_fim.strftime('%d/%m/%Y') }}{% endif %})
        </th>
      </tr>
    </thead>
    <tbody>
      {% set ordem_tipos = ['ALCA','SOLADO','MICRO','AMOSTRA'] %}
      {% set ns = namespace(tem_dados=false) %}

      {% for t in ordem_tipos %}
        {% set valor = totais_periodo.get(t, 0) %}
        {% if valor %}
          {% set ns.tem_dados = true %}
          <tr>
            <td class="text-start" style="background:#f0f8ff">{{ t }}</td>
            <td class="fw-bold text-primary" style="background:#f0f8ff">{{ valor }}</td>
          </tr>
        {% endif %}
      {% endfor %}

      {% if ns.tem_dados %}
        <tr>
          <td class="text-start fw-bold">TOTAL GERAL</td>
          <td class="fw-bold">{{ total_geral_periodo }}</td>
        </tr>
      {% else %}
        <tr>
          <td colspan="2" class="text-muted">Sem lançamentos no período.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>


{% endblock %}