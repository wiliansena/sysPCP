{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm mt-3">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> Nova Quebra de Produção — Alça</h5>
    </div>
  </div>

  <div class="card-body">
    <form method="POST">
      {{ form.csrf_token }}

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label mb-1">{{ form.data_quebra.label }}</label>
          {{ form.data_quebra(class="form-control") }}
          {% for e in form.data_quebra.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-9">
          <label class="form-label mb-1">{{ form.alca_id.label }}</label>
          {{ form.alca_id(class="form-select select2", id="alca_id") }}
          {% for e in form.alca_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-12">
          <label class="form-label mb-1">{{ form.observacao.label }}</label>
          {{ form.observacao(class="form-control", rows="2", placeholder="Observação (opcional)") }}
        </div>
      </div>

      <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0"><i class="fas fa-ruler-combined me-2"></i> Tamanhos</h6>
          <span class="text-muted small">Informe apenas onde houve quebra</span>
        </div>

        <div id="box-tamanhos" class="table-responsive d-none">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Tamanho</th>
                <th class="text-end" style="width:180px;">Quantidade quebrada</th>
              </tr>
            </thead>
            <tbody id="tamanhos-body"><!-- via JS --></tbody>
            <tfoot>
              <tr>
                <th class="text-end">Total</th>
                <th class="text-end"><span id="total-qtd">0</span></th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div id="tamanhos-placeholder" class="text-muted">
          Selecione a alça para carregar os tamanhos.
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-success"  >
          <i class="fas fa-save me-1"></i> Salvar
        </button>
        <a href="{{ url_for('routes.listar_quebras_alca') }}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>

<script>
  function renderTamanhos(lista) {
    const body = $('#tamanhos-body');
    body.empty();

    lista.forEach(t => {
      const row = `
        <tr>
          <td>${t.nome}</td>
          <td class="text-end">
            <input type="number" min="0" step="1"
                   class="form-control text-end qtd-input"
                   name="qtd_${t.id}"
                   placeholder="0">
          </td>
        </tr>`;
      body.append(row);
    });

    const recalc = () => {
      let s = 0;
      $('.qtd-input').each(function(){
        const raw = $(this).val();
        const v = raw === '' ? 0 : parseInt(raw, 10);
        if (!isNaN(v)) s += v;
      });
      $('#total-qtd').text(s);
    };
    $('.qtd-input').on('input', recalc);
    recalc();

    if (lista.length) {
      $('#box-tamanhos').removeClass('d-none');
      $('#tamanhos-placeholder').addClass('d-none');
    } else {
      $('#box-tamanhos').addClass('d-none');
      $('#tamanhos-placeholder').removeClass('d-none').text('Esta alça não possui tamanhos cadastrados.');
    }
  }

  async function carregarTamanhos() {
    const aid = parseInt($('#alca_id').val() || '0', 10);
    if (!aid) {
      $('#tamanhos-body').empty();
      $('#box-tamanhos').addClass('d-none');
      $('#tamanhos-placeholder').removeClass('d-none').text('Selecione a alça para carregar os tamanhos.');
      return;
    }
    try {
      const url = `{{ url_for('routes.api_quebra_alca_tamanhos') }}?alca_id=${aid}`;
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const data = await resp.json();
      if (data.ok) {
        renderTamanhos(data.tamanhos || []);
      } else {
        $('#tamanhos-body').empty();
        $('#box-tamanhos').addClass('d-none');
        $('#tamanhos-placeholder').removeClass('d-none').text(data.msg || 'Erro ao carregar tamanhos.');
      }
    } catch (e) {
      $('#tamanhos-body').empty();
      $('#box-tamanhos').addClass('d-none');
      $('#tamanhos-placeholder').removeClass('d-none').text('Erro ao carregar tamanhos.');
    }
  }

  $(function(){
    $('.select2').select2({ width: '100%', placeholder: 'Selecione...', allowClear: true });
    $('#alca_id').on('change', carregarTamanhos);
  });
</script>
{% endblock %}
