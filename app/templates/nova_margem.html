{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Cadastrar Nova Margem</h2>

    <form method="POST" action="{{ url_for('routes.nova_margem') }}">
        {{ form.hidden_tag() }}

        <!-- üîπ CLIENTE -->
        <div class="form-group">
            <h4>CLIENTE</h4>
            {{ form.cliente(class="form-control") }}
        </div>

        <!-- üîπ Sele√ß√£o da Refer√™ncia -->
        <h4>Refer√™ncia</h4>
        <div class="row">
            <div class="col-md-4">
                <input type="text" id="referencia_codigo" class="form-control" readonly placeholder="C√≥digo">
                <input type="hidden" id="referencia_id" name="referencia_id">
            </div>
            <div class="col-md-6">
                <input type="text" id="referencia_descricao" class="form-control" readonly placeholder="Descri√ß√£o">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#modalReferencias">
                    Selecionar
                </button>
            </div>
        </div>

        <!-- üîπ Sele√ß√£o da Embalagem -->
        <h4 class="mt-3">Escolha a Embalagem</h4>
        <div class="form-group">
            {{ form.embalagem_escolhida(class="form-select") }}
        </div>

        <!-- üîπ Pre√ßo de Venda -->
        <div class="form-group">
            <h4>Pre√ßo de Venda</h4>
            {{ form.preco_venda(class="form-control") }}
        </div>

        <!-- üîπ Despesas de Venda -->
        <h4>Despesas de Venda</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Descri√ß√£o</th>
                    <th>Porcentagem (%)</th>
                    <th>Valor (R$)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Comiss√£o</td>
                    <td>{{ form.comissao_porcentagem(class="form-control") }}</td>
                    <td>{{ form.comissao_valor(class="form-control") }}</td>
                </tr>
                <tr>
                    <td>Financeiro</td>
                    <td>{{ form.financeiro_porcentagem(class="form-control") }}</td>
                    <td>{{ form.financeiro_valor(class="form-control") }}</td>
                </tr>
                <tr>
                    <td>Duvidosos</td>
                    <td>{{ form.duvidosos_porcentagem(class="form-control") }}</td>
                    <td>{{ form.duvidosos_valor(class="form-control") }}</td>
                </tr>
                <tr>
                    <td>Frete</td>
                    <td>{{ form.frete_porcentagem(class="form-control") }}</td>
                    <td>{{ form.frete_valor(class="form-control") }}</td>
                </tr>
                <tr>
                    <td>Tributos</td>
                    <td>{{ form.tributos_porcentagem(class="form-control") }}</td>
                    <td>{{ form.tributos_valor(class="form-control") }}</td>
                </tr>
                <tr>
                    <td>Outros</td>
                    <td>{{ form.outros_porcentagem(class="form-control") }}</td>
                    <td>{{ form.outros_valor(class="form-control") }}</td>
                </tr>
            </tbody>
        </table>

        <button type="submit" class="btn btn-success">Salvar</button>
        <a href="{{ url_for('routes.listar_margens') }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- üîπ Modal para Selecionar Refer√™ncia -->
<div class="modal fade" id="modalReferencias" tabindex="-1" aria-labelledby="modalReferenciasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecionar Refer√™ncia</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Campo de filtro -->
                <div class="mb-3">
                    <input type="text" id="filterReferencia" class="form-control" placeholder="Filtrar Refer√™ncia">
                </div>
                <!-- üîπ Tabela para listar refer√™ncias -->
                <table class="table" id="referenciaTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>C√≥digo</th>
                            <th>Descri√ß√£o</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for referencia in referencias %}
                        <tr>
                            <td>{{ referencia.id }}</td>
                            <td>{{ referencia.codigo_referencia }}</td>
                            <td>{{ referencia.descricao }}</td>
                            <td>
                                <button type="button" class="btn btn-success btn-sm" 
                                    onclick="selecionarReferencia(
                                        '{{ referencia.id }}', 
                                        '{{ referencia.codigo_referencia }}', 
                                        '{{ referencia.descricao }}'
                                    )">
                                    Selecionar
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-danger">Nenhuma refer√™ncia encontrada</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Script para filtrar todas as tabelas -->
<script>
    function setupFilter(filterId, tableId) {
        const filterInput = document.getElementById(filterId);
        if (filterInput) {
            filterInput.addEventListener('keyup', function () {
                let filtro = this.value.toUpperCase();
                let rows = document.querySelectorAll('#' + tableId + ' tbody tr');
                rows.forEach(row => {
                    let col1 = row.querySelector('td:nth-child(1)').textContent.toUpperCase();
                    let col2 = row.querySelector('td:nth-child(2)').textContent.toUpperCase();
                    if (col1.indexOf(filtro) > -1 || col2.indexOf(filtro) > -1) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
    }

    // Ativar filtros
    setupFilter('filterReferencia', 'referenciaTable');
</script>

<!-- üîπ Script para Selecionar Refer√™ncia -->
<script>
function selecionarReferencia(id, codigo, descricao) {
    document.getElementById('referencia_id').value = id;
    document.getElementById('referencia_codigo').value = codigo;
    document.getElementById('referencia_descricao').value = descricao;

    $('#modalReferencias').modal('hide');
}
</script>

{% endblock %}
