{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Cadastro de Solado</h2>
    <hr>

    <!-- üîπ Adicionado action na form -->
    <form method="POST" action="{{ url_for('routes.novo_solado') }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="form-group">
            <label>Refer√™ncia</label>
            {{ form.referencia(class="form-control") }}
        </div>

        <div class="form-group">
            <label>Descri√ß√£o</label>
            {{ form.descricao(class="form-control") }}
        </div>
        <hr>
        <div class="col-md-3">
            <div class="form-group">
                <label>Imagem do solado</label>
                {{ form.imagem(class="form-control-file") }}
            </div>
        </div>
        <hr>

        <h4>Ficha T√©cnica</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Tamanhos</th>
                    {% for i in range(8) %}
                    <th>{{ form.tamanhos[i].nome(class="form-control") }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><b>GRADE</b></td>
                    {% for i in range(8) %}
                    <td>{{ form.tamanhos[i].quantidade(class="form-control" ) }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td><b>Peso M√©dio</b></td>
                    {% for i in range(8) %}
                    <td>{{ form.tamanhos[i].peso_medio(class="form-control", step="0.000001") }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td><b>Peso M√©dio Friso</b></td>
                    {% for i in range(8) %}
                    <td>{{ form.tamanhos[i].peso_friso(class="form-control", step="0.000001") }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td><b>Peso M√©dio sem Friso</b></td>
                    {% for i in range(8) %}
                    <td>{{ form.tamanhos[i].peso_sem_friso(class="form-control", step="0.000001") }}</td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>


        <h4>Formula√ß√£o do Solado</h4>
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalComponentes">
            Adicionar
        </button>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>C√≥d</th>
                    <th>Descri√ß√£o</th>
                    <th>Pre√ßo</th>
                    <th>Carga (Kg)</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabela-sem_friso">
                {% for item in form.formulacao %}
                <tr data-id="{{ item.componente_id.data }}">
                    <td>
                        <input type="hidden" name="componentes[]" value="{{ item.componente_id.data }}">
                        {{ item.componente_id.data }}
                    </td>
                    <td>
                        <input type="hidden" name="descricao[]" value="{{ item.descricao.data }}">
                        {{ item.descricao.data }}
                    </td>
                    <td>
                        <input type="hidden" name="preco[]" value="{{ item.preco.data }}">
                        R$ {{ item.preco.data }}
                    </td>
                    <td>
                        <input type="number" name="carga[]" class="form-control carga-input"
                            value="{{ item.carga.data }}" step="0.000001" min="0">
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remover-componente">Remover</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <h4>Formula√ß√£o do Solado (Com Friso)</h4>
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
            data-bs-target="#modalComponentesFriso">
            Adicionar
        </button>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>C√≥d</th>
                    <th>Descri√ß√£o</th>
                    <th>Valor do Componente</th>
                    <th>Carga (Kg)</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabela-friso">
                {% for item in form.formulacao %}
                <tr data-id="{{ item.componente_id.data }}">
                    <td>
                        <input type="hidden" name="componentes[]" value="{{ item.componente_id.data }}">
                        {{ item.componente_id.data }}
                    </td>
                    <td>
                        <input type="hidden" name="descricao[]" value="{{ item.descricao.data }}">
                        {{ item.descricao.data }}
                    </td>
                    <td>
                        <input type="hidden" name="preco[]" value="{{ item.preco.data }}">
                        R$ {{ item.preco.data }}
                    </td>
                    <td>
                        <input type="number" name="carga[]" class="form-control carga-input"
                            value="{{ item.carga.data }}" step="0.000001" min="0">
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remover-componente">Remover</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>


        <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Salvar</button>
        <a href="{{ url_for('routes.listar_solados') }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- üîπ Modal para selecionar componentes (Sem Friso) -->
<div class="modal fade" id="modalComponentes" tabindex="-1" aria-labelledby="modalComponentesLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecionar Componentes</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Campo de filtro -->
                <div class="mb-3">
                    <input type="text" id="filterComponentesSemFriso" class="form-control"
                        placeholder="Filtrar Componentes Sem Friso">
                </div>
                <table class="table" id="componentesSemFrisoTable">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descri√ß√£o</th>
                            <th>Pre√ßo</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for componente in componentes %}
                        <tr>
                            <td>{{ componente.codigo }}</td>
                            <td>{{ componente.descricao }}</td>
                            <td>R$ {{ "%.4f"|format(componente.preco) }}</td>
                            <td>
                                <button type="button" class="btn btn-success btn-sm selecionar-componente"
                                    data-id="{{ componente.id }}" data-descricao="{{ componente.descricao }}"
                                    data-preco="{{ " %.4f"|format(componente.preco) }}" data-tipo="sem_friso">
                                    Selecionar
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- üîπ Modal para selecionar componentes (Com Friso) -->
<div class="modal fade" id="modalComponentesFriso" tabindex="-1" aria-labelledby="modalComponentesFrisoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecionar Componentes (Com Friso)</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Campo de filtro -->
                <div class="mb-3">
                    <input type="text" id="filterComponentesFriso" class="form-control"
                        placeholder="Filtrar Componentes Com Friso">
                </div>
                <table class="table" id="componentesFrisoTable">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descri√ß√£o</th>
                            <th>Pre√ßo</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for componente in componentes %}
                        <tr>
                            <td>{{ componente.codigo }}</td>
                            <td>{{ componente.descricao }}</td>
                            <td>R$ {{ "%.4f"|format(componente.preco) }}</td>
                            <td>
                                <button type="button" class="btn btn-success btn-sm selecionar-componente"
                                    data-id="{{ componente.id }}" data-descricao="{{ componente.descricao }}"
                                    data-preco="{{ " %.4f"|format(componente.preco) }}" data-tipo="friso">
                                    Selecionar
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Script para filtrar as tabelas dos modais -->
<script>
    function setupFilter(filterId, tableId) {
        const filterInput = document.getElementById(filterId);
        if (filterInput) {
            filterInput.addEventListener('keyup', function () {
                const filtro = this.value.toUpperCase();
                const rows = document.querySelectorAll('#' + tableId + ' tbody tr');
                rows.forEach(row => {
                    const col1 = row.querySelector('td:nth-child(1)').textContent.toUpperCase();
                    const col2 = row.querySelector('td:nth-child(2)').textContent.toUpperCase();
                    row.style.display = (col1.indexOf(filtro) > -1 || col2.indexOf(filtro) > -1) ? '' : 'none';
                });
            });
        }
    }

    setupFilter('filterComponentesSemFriso', 'componentesSemFrisoTable');
    setupFilter('filterComponentesFriso', 'componentesFrisoTable');
</script>

<script>
    $(document).ready(function () {
        $(".selecionar-componente").click(function () {
            let id = $(this).data("id");
            let descricao = $(this).data("descricao");
            let preco = $(this).data("preco");
            let tipo = $(this).data("tipo");  // Identifica se √© sem friso ou com friso

            console.log("Selecionando componente - ID:", id, "Tipo:", tipo);

            // Define a tabela correta com base no tipo do componente
            let tabela;
            if (tipo === "friso") {
                tabela = $("#tabela-friso");
            } else {
                tabela = $("#tabela-sem_friso");
            }

            // Garante que a tabela foi identificada corretamente
            if (tabela.length === 0) {
                console.error("Erro: Tabela n√£o encontrada para o tipo", tipo);
                return;
            }

            let novaLinha = `
            <tr class="linha-adicionada" data-id="${id}">
                <td><input type="hidden" name="componentes_${tipo}[]" value="${id}">${id}</td>
                <td>${descricao}</td>
                <td>R$ ${preco}</td>
                <td><input type="number" name="carga_${tipo}[]" class="form-control carga-input" step="0.000001" min="0"></td>
                <td><button type="button" class="btn btn-danger btn-sm remover-componente">Remover</button></td>
            </tr>
        `;

            tabela.append(novaLinha);
         //   $("#modalComponentes, #modalComponentesFriso").modal("hide");  // Fecha os modais corretamente
        });

        $(document).on("click", ".remover-componente", function () {
            $(this).closest("tr").remove();
        });

        // üîπ Antes de enviar o formul√°rio, preenche automaticamente os campos vazios
        $("form").on("submit", function () {
            console.log("Preenchendo valores vazios antes de enviar...");

            // üîπ Garante que todos os campos de n√∫mero (carga, pesos, quantidade) sejam preenchidos corretamente
            $("input[type='number']").each(function () {
                if ($(this).val().trim() === "" || isNaN($(this).val())) {
                    $(this).val(0); // Define 0 como valor padr√£o para quantidade e carga
                }
            });

            // üîπ Preenche campos de texto (nomes dos tamanhos) com um valor padr√£o "--" se estiverem vazios
            $("input[name*='nome']").each(function () {
                if ($(this).val().trim() === "") {
                    $(this).val("--");  // Define "--" para indicar um valor padr√£o
                }
            });

            // üîπ Garante que os campos de peso (peso_medio, peso_friso, peso_sem_friso) sejam preenchidos com 0.0
            $("input[name*='peso_medio'], input[name*='peso_friso'], input[name*='peso_sem_friso']").each(function () {
                if ($(this).val().trim() === "" || isNaN($(this).val())) {
                    $(this).val(0.0);  // Define 0.0 para os pesos
                }
            });

            // üîπ Depura√ß√£o (Opcional: Exibe os dados no console antes de enviar)
            console.log("Campos preenchidos automaticamente:", $(this).serializeArray());
        });
    });

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        for (let i = 0; i < 8; i++) {
            let campo = document.getElementById(`tamanhos-${i}-nome`);
            if (campo) {
                campo.addEventListener("input", function () {
                    let valor = campo.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero

                    if (valor.length > 2) {
                        valor = valor.slice(0, 2) + '/' + valor.slice(2);
                    }

                    campo.value = valor;
                });
            }
        }
    });
</script>

{% endblock %}