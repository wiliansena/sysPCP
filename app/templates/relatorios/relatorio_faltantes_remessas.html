{% extends "base.html" %}
{% block content %}
<div class="container mt-3">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2><i class="fas fa-boxes-stacked me-2"></i> Resumo de Produção</h2>
    <a class="btn btn-secondary" href="{{ url_for('routes.home') }}">Voltar</a>
  </div>

  <!-- Filtros -->
  <form method="GET" class="row g-2 mb-3">
    <div class="col-md-5">
      <label class="form-label mb-1">Remessas</label>
      <select name="remessa_id" class="form-select select2" multiple>
        {% for r in todas_remessas %}
          <option value="{{ r.id }}"
            {% if r.id in filtros.remessa_ids %}selected{% endif %}>
            {{ r.codigo }} — {{ r.nome or r.descricao or '' }}
          </option>
        {% endfor %}
      </select>
      <small class="text-muted">Selecione uma ou mais remessas</small>
    </div>

    <div class="col-md-3">
      <label class="form-label mb-1">Referência (contém)</label>
      <input type="text" name="referencia" value="{{ filtros.referencia or '' }}" class="form-control" placeholder="Ex.: BK787">
    </div>

    <div class="col-md-2">
      <label class="form-label mb-1">Fonte de Produção</label>
      <select name="fonte" class="form-select">
        <option value="esteira" {% if filtros.fonte == 'esteira' %}selected{% endif %}>Esteira (Planejamento)</option>
        <option value="diaria" {% if filtros.fonte == 'diaria' %}selected{% endif %}>Produção Diária</option>
      </select>
    </div>

    <div class="col-md-2 d-flex align-items-end gap-2">
      <div class="form-check me-2">
        <input class="form-check-input" type="checkbox" name="somente_fechados" value="1" id="chkFechados"
               {% if filtros.somente_fechados %}checked{% endif %}>
        <label class="form-check-label" for="chkFechados">Somente fechados</label>
      </div>
      <button class="btn btn-primary" type="submit"><i class="fas fa-filter me-1"></i>Filtrar</button>
    </div>
  </form>

  {% if remessa_data %}
    {% for rid, bloco in remessa_data.items() %}
      <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <strong>Remessa:</strong> {{ bloco.remessa.id }} — {{ bloco.remessa.nome or bloco.remessa.descricao or '—' }}
          </div>
          <div class="d-flex gap-3">
            <span class="badge bg-secondary">Planejado: {{ bloco.total_planejado }}</span>
            <span class="badge bg-success">Produzido: {{ bloco.total_produzido }}</span>
            <span class="badge bg-warning text-dark">Restante: {{ bloco.total_restante }}</span>
          </div>
        </div>

        <div class="card-body p-0">
          {% if bloco.faltantes %}
            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead class="table-light">
                  <tr class="text-center">
                    <th style="width: 140px;">Referência</th>
                    <th style="width: 120px;">Setor</th>
                    <th style="width: 110px;">Status</th>
                    <th style="width: 140px;">Planejado</th>
                    <th style="width: 140px;">Produzido</th>
                    <th style="width: 140px;">Faltando</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in bloco.faltantes %}
                    <tr class="text-center">
                      <td>{{ item.referencia }}</td>
                      <td>{{ item.setor }}</td>
                      <td>
                        {% if item.fechado %}
                          <span class="badge bg-success">Fechado</span>
                        {% else %}
                          <span class="badge bg-secondary">Aberto</span>
                        {% endif %}
                      </td>
                      <td>{{ item.planejado }}</td>
                      <td>{{ item.produzido }}</td>
                      <td>
                        {% if item.faltando > 0 %}
                        <strong class="text-danger">{{ item.faltando }}</strong>
                        {% else %}
                        <strong>{{ item.faltando }}</strong>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-3">
              <em>Tudo certo! Não há faltantes para esta remessa com os filtros atuais.</em>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">Nenhum dado encontrado com os filtros aplicados.</div>
  {% endif %}
</div>
{% endblock %}
