{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h3><i class="fas fa-edit"></i> Editar Componente #{{ componente.id }}</h3>
    <a href="{{ url_for('routes.listar_componentes') }}" class="btn btn-outline-secondary">Voltar</a>
  </div>
  <hr>

  <form method="POST" action="{{ url_for('routes.editar_componente', id=componente.id) }}">
    {{ form.hidden_tag() }}

    <div class="row">
      <div class="mb-3 col-md-3">
        {{ form.codigo.label(class="form-label") }}
        {{ form.codigo(class="form-control") }}
      </div>

      <div class="mb-3 col-md-3">
        {{ form.tipo.label(class="form-label") }}
        {{ form.tipo(class="form-select") }}
      </div>

      <div class="mb-3 col-md-6">
        {{ form.descricao.label(class="form-label") }}
        {{ form.descricao(class="form-control") }}
      </div>

      <div class="mb-3 col-md-3">
        {{ form.unidade_medida.label(class="form-label") }}
        {{ form.unidade_medida(class="form-select") }}
      </div>

      <div class="mb-3 col-md-3">
        {{ form.preco.label(class="form-label") }}
        {{ form.preco(class="form-control") }}
      </div>
    </div>

<div class="col-12 col-md-8">
  <label class="form-label">Fornecedor (opcional)</label>
  <select name="fornecedor_id" id="fornecedor_id" class="form-select select2" data-placeholder="Selecione o fornecedor">
    <option></option>
    {% for forn in fornecedores %}
      <option value="{{ forn.id }}"
        {% if componente.fornecedor_id == forn.id %}selected{% endif %}>
        {{ forn.nome }}
      </option>
    {% endfor %}
  </select>
  <small class="text-muted">Se nenhum fornecedor for selecionado, ficará <em>null</em>.</small>
</div>



    <hr>
    <h5>Cores do componente</h5>
    <div class="mb-2">
      <label class="form-label">Selecione as cores</label>
      <select name="cores[]" class="form-select select2" multiple data-placeholder="Selecione as cores">
        {% for cor in cores %}
        <option value="{{ cor.id }}" {% if cor.id in vinculadas_ids %}selected{% endif %}>
          {{ cor.nome }}
        </option>
        {% endfor %}
      </select>
      <small class="text-muted">
        Se nenhuma cor for selecionada, será usado “Sem cor”.<br>
        Desmarcar uma cor tenta removê-la; se houver saldo, ela não será removida.
      </small>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button type="submit" class="btn btn-success">Salvar</button>
      <a href="{{ url_for('routes.listar_componentes') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    $('.select2').select2({
      width: '100%',
      placeholder: 'Selecione',
      allowClear: true
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Inicializa TODOS os select2 da tela
    $('.select2').select2({
      width: '100%',
      placeholder: 'Selecione',
      allowClear: true,
      minimumResultsForSearch: 0
    }).on('select2:open', function () {
      setTimeout(() => {
        const s = document.querySelector('.select2-container--open .select2-search__field');
        if (s) s.focus();
      }, 0);
    });

    // Força mostrar o fornecedor atual no Select2 (caso o plugin esconda pelo placeholder)
    const fornecedorAtual = "{{ componente.fornecedor_id or '' }}";
    if (fornecedorAtual) {
      $('#fornecedor_id').val(fornecedorAtual).trigger('change', {fromInit:true});
    }
  });
</script>

{% endblock %}